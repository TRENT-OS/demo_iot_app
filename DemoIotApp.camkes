/**
 * Main CAmkES configuration file of the IoT demo application.
 *
 * Copyright (C) 2020-2021, HENSOLDT Cyber GmbH
 */

import <std_connector.camkes>;

#include "system_config.h"

import <if_OS_Entropy.camkes>;
import <if_OS_Timer.camkes>;

#include "ChanMux/ChanMux_UART.camkes"
ChanMux_UART_COMPONENT_DEFINE(
    ChanMux_UART,
    chanMuxStorage, chan,
    nwDriver, data,
    nwDriver, ctrl
)

#include "Storage_ChanMux/Storage_ChanMux.camkes"
Storage_ChanMux_COMPONENT_DEFINE(Storage_ChanMux)

#include "NIC_ChanMux/NIC_ChanMux.camkes"
NIC_ChanMux_COMPONENT_DEFINE(NwDriver, NIC_DRIVER_RINGBUFFER_SIZE)

#include "EntropySource/camkes/EntropySource.camkes"
EntropySource_COMPONENT_DEFINE(EntropySource)

#include "TimeServer/camkes/TimeServer.camkes"
TimeServer_COMPONENT_DEFINE(TimeServer)

#include "StorageServer/camkes/StorageServer.camkes"
StorageServer_COMPONENT_DEFINE(StorageServer)

import "components/Sensor/Sensor.camkes";
import "components/CloudConnector/CloudConnector.camkes";
import "components/LogServer/LogServer.camkes";
#include "components/NwStack/network_stack.camkes";
import "components/Ticker/Ticker.camkes";
import "components/ConfigServer/ConfigServer.camkes";

assembly {
    composition {

        //----------------------------------------------------------------------
        // ChanMux + UART
        //----------------------------------------------------------------------
        component ChanMux_UART chanMux_UART;
        component UART_CHANMUX uart;
        ChanMux_UART_INSTANCE_CONNECT(chanMux_UART, uart)

        //----------------------------------------------------------------------
        // Ticker
        //----------------------------------------------------------------------
        component  Ticker ticker;

        //----------------------------------------------------------------------
        // TimeServer
        //----------------------------------------------------------------------
        component TimeServer timeServer;

        TimeServer_INSTANCE_CONNECT_CLIENTS(
            timeServer,
            ticker.timeServer_rpc,          ticker.timeServer_notify,
            nwStack.timeServer_rpc,         nwStack.timeServer_notify,
            cloudConnector.timeServer_rpc,  cloudConnector.timeServer_notify,
            logServer.timeServer_rpc,       logServer.timeServer_notify,
            sensorTemp.timeServer_rpc,      sensorTemp.timeServer_notify
        )

        //----------------------------------------------------------------------
        // ChanMuxStorage
        //----------------------------------------------------------------------
        component Storage_ChanMux chanMuxStorage;

        ChanMux_UART_INSTANCE_CONNECT_CLIENT(
            chanMux_UART,
            chanMuxStorage, chan
        )

        //----------------------------------------------------------------------
        // StorageServer
        //----------------------------------------------------------------------
        component StorageServer storageServer;

        StorageServer_INSTANCE_CONNECT(
            storageServer,
            chanMuxStorage.storage_rpc, chanMuxStorage.storage_port
        )
        StorageServer_INSTANCE_CONNECT_CLIENTS(
            storageServer,
            configServer.storage_rpc,  configServer.storage_port,
            logServer.storage_rpc, logServer.storage_port
        )

        //----------------------------------------------------------------------
        // ConfigServer
        //----------------------------------------------------------------------
        component ConfigServer configServer;

        connection seL4RPCCall configServer_logServer(
            from configServer.logServer_rpc,
            to   logServer.logServer_rpc);

        connection seL4SharedData configServer_logServer_data(
            from configServer.logServer_port,
            to   logServer.configServer_port);

        //----------------------------------------------------------------------
        // LogServer
        //----------------------------------------------------------------------
        component LogServer logServer;

        //----------------------------------------------------------------------
        // Network Driver
        //----------------------------------------------------------------------
        component NwDriver nwDriver;

        ChanMux_UART_INSTANCE_CONNECT_CLIENT(
            chanMux_UART,
            nwDriver, data, ctrl
        )

        NIC_ChanMux_INSTANCE_CONNECT_OPTIONAL_LOGGER(
            nwDriver,
            logServer.logServer_rpc,
            logServer.nwDriver_port
        )

        //----------------------------------------------------------------------
        // Network Stack
        //----------------------------------------------------------------------
        component NwStack nwStack;

        NETWORK_STACK_CONNECT_CONFIGSERVER(nwStack, configServer)
        NETWORK_STACK_CONNECT_LOGSERVER(nwStack, logServer)

        NwStack_INSTANCE_CONNECT(
            nwStack,
            ticker.e_timeout_nwstacktick,
            nwDriver
        )

        //----------------------------------------------------------------------
        // CloudConnector
        //----------------------------------------------------------------------
        component CloudConnector cloudConnector;

        connection seL4RPCCall cloudConnector_nwStack(
            from cloudConnector.networkStack_rpc,
            to   nwStack.networkStack_rpc);

        connection seL4SharedData NwApp_dataConnection(
            from cloudConnector.networkStack_port,
            to   nwStack.socket_1_port);

        connection seL4RPCCall cloudConnector_configServer(
            from cloudConnector.OS_ConfigServiceServer,
            to   configServer.OS_ConfigServiceServer);

        connection seL4SharedData cloudConnector_configServer_data(
            from cloudConnector.configServer_port,
            to   configServer.cloudConnector_port);

        connection seL4RPCCall cloudConnector_logServer(
            from cloudConnector.logServer_rpc,
            to   logServer.logServer_rpc);

        connection seL4SharedData cloudConnector_logServer_data(
            from cloudConnector.logServer_port,
            to   logServer.cloudConnector_port);

        //----------------------------------------------------------------------
        // EntropySource
        //----------------------------------------------------------------------
        component EntropySource entropySource;

        EntropySource_INSTANCE_CONNECT_CLIENT(
            entropySource,
            cloudConnector.entropy_rpc,
            cloudConnector.entropy_port)

        //----------------------------------------------------------------------
        // SensorTemp
        //----------------------------------------------------------------------
        component SensorTemp sensorTemp;

        connection seL4SharedData cloudConnectorData_sensorTemp_data(
            from sensorTemp.cloudConnector_port,
            to   cloudConnector.sensor_port);

        connection seL4RPCCall cloudConnector_sensorTemp(
            from sensorTemp.cloudConnector_rpc,
            to   cloudConnector.cloudConnector_rpc);

        connection seL4RPCCall sensorTemp_configServer(
            from sensorTemp.OS_ConfigServiceServer,
            to   configServer.OS_ConfigServiceServer);

        connection seL4SharedData sensorTemp_configServer_data(
            from sensorTemp.configServer_port,
            to   configServer.sensor_port);

        connection seL4RPCCall sensorTemp_logServer(
            from sensorTemp.logServer_rpc,
            to   logServer.logServer_rpc);

        connection seL4SharedData sensorTemp_logServer_data(
            from sensorTemp.logServer_port,
            to   logServer.sensor_port);

    }
    configuration {
        /* client IDs */
        configServer.logServer_rpc_attributes =   CONFIGSERVER_LOGGER_ID;
        cloudConnector.logServer_rpc_attributes = CLOUDCONNECTOR_LOGGER_ID;
        sensorTemp.logServer_rpc_attributes =     SENSOR_LOGGER_ID;
        nwDriver.logServer_rpc_attributes =       NWDRIVER_LOGGER_ID;
        nwStack.logServer_rpc_attributes =        NWSTACK_LOGGER_ID;

        ChanMux_UART_CLIENT_ASSIGN_BADGES(
            nwDriver.chanMux_Rpc,
            chanMuxStorage.chanMux_Rpc
        )

        StorageServer_INSTANCE_CONFIGURE_CLIENTS(
            storageServer,
            CONFIGSERVER_STORAGE_OFFSET, CONFIGSERVER_STORAGE_SIZE,
            LOGSERVER_STORAGE_OFFSET,    LOGSERVER_STORAGE_SIZE
        )
        StorageServer_CLIENT_ASSIGN_BADGES(
            configServer.storage_rpc,
            logServer.storage_rpc
        )

        TimeServer_CLIENT_ASSIGN_BADGES(
            ticker.timeServer_rpc,
            nwStack.timeServer_rpc,
            cloudConnector.timeServer_rpc,
            logServer.timeServer_rpc,
            sensorTemp.timeServer_rpc
        )

        /* assign an initial value to semaphore */
        cloudConnector.sem_value = 0;
    }
}

